# Requirements Document

## Introduction

現在のブログサイトにおいて、外部リンクのプレビューカード（リンクカード）が適切に表示されない問題が発生している。この問題により、ブログ記事内の外部リンクが通常のテキストリンクとして表示され、リーダーのユーザー体験が低下している。本仕様では、リンクカード機能を修正し、開発環境・本番環境の両方で正常に動作するようにすることを目的とする。

## Requirements

### Requirement 1: 開発環境でのリンクカード表示

**Objective:**
開発者として、開発環境でもリンクカードが表示されることにより、本番環境との一貫性を保ちたい

#### Acceptance Criteria

1. WHEN 開発者が`deno task serve`でローカル開発サーバーを起動するTHEN
   リンクカードプラグインが有効化されていること
2. WHEN ブログ記事内に単独のURLが記述されている THEN
   そのURLがリンクカードとして表示されること
3. WHEN 開発環境でリンクカードが生成される THEN
   本番環境と同じHTML構造とスタイリングが適用されること
4. IF `RELEASE`環境変数が設定されていない THEN
   リンクカードプラグインが依然として動作すること

### Requirement 2: OGPデータの正確な取得と処理

**Objective:** サイト管理者として、外部サイトのOGP（Open Graph
Protocol）データが正確に取得され、適切にリンクカードに表示されることで、リンクの内容がわかりやすくなることを望む

#### Acceptance Criteria

1. WHEN 外部URLのOGPデータを取得する THEN
   タイトル、画像、サイト名が正確に抽出されること
2. IF OGPタイトルが存在しない THEN
   HTMLのtitleタグの内容をフォールバックとして使用すること
3. WHEN OGPデータの取得でエラーが発生する THEN
   エラーが適切にハンドリングされ、基本的なリンク情報（URL、ドメイン名）が表示されること
4. WHILE OGPデータを取得している間 THE
   システムは適切なタイムアウト（10秒）を設定してハング状態を防ぐこと
5. WHERE 画像URLが相対パスである場合 THE システムは絶対URLに変換して表示すること

### Requirement 3: リンクカードのHTML出力とスタイリング

**Objective:**
サイト利用者として、視覚的に魅力的で使いやすいリンクカードが表示されることで、外部リンクの内容を素早く理解できるようになりたい

#### Acceptance Criteria

1. WHEN リンクカードが生成される THEN
   カード形式のレイアウト（タイトル、サイト名、サムネイル画像）で表示されること
2. WHEN リンクカードをクリックする THEN 元のURLに正しくナビゲートされること
3. IF サムネイル画像が存在する THEN カードの右側に適切なサイズで表示されること
4. WHEN モバイルデバイスで表示される THEN
   レスポンシブデザインに対応した適切なレイアウトで表示されること
5. WHERE リンクカード内のテキストが長すぎる場合 THE
   システムは省略記号（...）で適切に切り詰めること

### Requirement 4: キャッシュとパフォーマンス

**Objective:**
サイト管理者として、OGPデータの取得が効率的に行われ、ビルド時間が最適化されることで、開発とデプロイメントの効率を向上させたい

#### Acceptance Criteria

1. WHEN 同じURLのOGPデータを複数回要求される THEN
   キャッシュされたデータを使用すること
2. WHEN ビルドプロセスでリンクカードを生成する THEN
   並列処理により効率的に処理されること
3. IF `NO_CACHE`環境変数が設定されている THEN
   キャッシュを使用せずに常に最新のデータを取得すること
4. WHILE ビルドプロセスが実行されている間 THE
   システムはOGPデータ取得エラーによってビルドが停止しないこと

### Requirement 5: エラーハンドリングとデバッグ機能

**Objective:**
開発者として、リンクカード機能の問題を素早く特定し、デバッグできるようになりたい

#### Acceptance Criteria

1. WHEN OGPデータの取得でエラーが発生する THEN
   エラー情報が適切にログに記録されること
2. WHEN デバッグモードが有効である THEN
   取得したOGPデータの詳細がログに出力されること
3. IF ネットワークエラーや無効なURLが原因でエラーが発生する THEN
   システムは例外をキャッチして基本的なリンク表示にフォールバックすること
4. WHILE 開発環境で作業している間 THE
   開発者はリンクカードの生成状況をリアルタイムで確認できること

### Requirement 6: 設定とカスタマイズ

**Objective:**
サイト管理者として、リンクカード機能の動作を環境に応じて柔軟に制御できるようになりたい

#### Acceptance Criteria

1. WHEN 開発環境と本番環境の設定を区別する必要がある THEN
   環境変数による適切な制御が可能であること
2. IF 特定の環境でリンクカード機能を無効にする必要がある THEN
   設定により簡単に無効化できること
3. WHEN Lumeの設定を変更する THEN
   リンクカードプラグインの動作が適切に反映されること
4. WHERE JSRやその他の特殊なサイトへのアクセスが必要な場合 THE
   システムは適切なHTTPヘッダーを設定すること
